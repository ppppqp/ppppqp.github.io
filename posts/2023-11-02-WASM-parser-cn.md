---
title: "WASM 101 | äºŒè¿›åˆ¶æ ¼å¼"
date: "2023-11-02"
author: "Retep"
tag: "Tech"
language: "CN"
noSSR: 0
---

## Meta-Intro

WASMï¼ˆWebAssemblyï¼‰æ˜¯ä¸€ä¸ªè™šæ‹ŸæŒ‡ä»¤é›†ï¼Œå…·å¤‡äº†è·¨å¹³å°å¯ç§»æ¤æ€§ã€ç®€å•æ€§ã€å‡ºè‰²çš„æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚

## Intro

è¿™ç¯‡åšå®¢ä¸­æˆ‘ä»¬ä¼šæ¢ç´¢ WASM çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼šäºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ã€‚WASM ä»¥äºŒè¿›åˆ¶å½¢å¼å‘å¸ƒï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ›´é«˜æ•ˆä¸”å®‰å…¨ï¼ˆè‡³å°‘æ¯” JavaScript è¿™ç§è„šæœ¬è¯­è¨€æ›´éš¾é€†å‘å·¥ç¨‹ ğŸ˜‰ï¼‰ã€‚

WASM äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥é€šè¿‡ WASM ç¼–è¯‘å™¨ä»å…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼ˆæ¯”å¦‚ Cï¼‰ç¼–è¯‘è€Œæ¥ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ä»[WasmFiddle](https://wasdk.github.io/WasmFiddle/)è·å– WASM äºŒè¿›åˆ¶æ–‡ä»¶ï¼šæŠŠç¤ºä¾‹ç¨‹åºï¼ˆåœ¨ Appendix ä¸­ï¼‰copy pasteï¼Œç¼–è¯‘ï¼Œç„¶åä¸‹è½½ WASM æ–‡ä»¶ã€‚

çœ‹çœ‹ä¸‹è½½çš„`fib.wasm`æ–‡ä»¶é‡Œæœ‰å•¥ï¼š

```bash
~ Â» hexdump -C fib.wasm
00000000  00 61 73 6d 01 00 00 00  01 8a 80 80 80 00 02 60  |.asm...........`|
00000010  01 7f 01 7f 60 00 01 7f  03 83 80 80 80 00 02 00  |....`...........|
00000020  01 04 84 80 80 80 00 01  70 00 00 05 83 80 80 80  |........p.......|
00000030  00 01 00 01 06 81 80 80  80 00 00 07 97 80 80 80  |................|
00000040  00 03 06 6d 65 6d 6f 72  79 02 00 03 66 69 62 00  |...memory...fib.|
00000050  00 04 6d 61 69 6e 00 01  0a d7 80 80 80 00 02 c6  |..main..........|
00000060  80 80 80 00 01 02 7f 41  01 21 02 02 40 20 00 41  |.......A.!..@ .A|
00000070  01 72 41 01 46 0d 00 20  00 41 7e 6a 21 00 41 01  |.rA.F.. .A~j!.A.|
00000080  21 02 03 40 20 00 41 01  6a 10 00 20 02 6a 21 02  |!..@ .A.j.. .j!.|
00000090  20 00 41 01 72 21 01 20  00 41 7e 6a 21 00 20 01  | .A.r!. .A~j!. .|
000000a0  41 01 47 0d 00 0b 0b 20  02 0b 86 80 80 80 00 00  |A.G.... ........|
000000b0  41 05 10 00 0b                                    |A....|
000000b5

```

ç›®å‰çœ‹èµ·æ¥ä¹±ä¸ƒå…«ç³Ÿçš„ ğŸ¤¨ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åˆ†æã€‚

## Meta-info

é¦–å…ˆï¼Œæ•´ä¸ª wasm æ–‡ä»¶ä¼šç”± 8 ä¸ªå­—èŠ‚çš„ meta-info å¼€å§‹ã€‚

### Magic Bytes

```bash
00000000 00 61 73 6d 01 00 00 00  01 8a 80 80 80 00 02 60  |.asm...........`|
          ^  ^  ^  ^
```

å‰ 4 ä¸ªå­—èŠ‚ï¼ˆå³`00 61 73 6d`ï¼‰å«é­”æœ¯å­—èŠ‚(magic bytes)ã€‚å®ƒä»¬è¡¨æ˜è¿™ä¸ªæ–‡ä»¶æ˜¯ WASM äºŒè¿›åˆ¶è¡¨ç¤ºã€‚

> [!info]
> "é­”æœ¯å­—èŠ‚"ï¼ˆMagic bytesï¼‰æ˜¯æ–‡ä»¶ä¸­çš„ç‰¹å®šå­—èŠ‚åºåˆ—ï¼Œé€šå¸¸ç”¨äºæ ‡è¯†æ–‡ä»¶çš„æ ¼å¼æˆ–ç±»å‹ã€‚è¿™äº›å­—èŠ‚åºåˆ—é€šå¸¸ä½äºæ–‡ä»¶çš„èµ·å§‹ä½ç½®ï¼Œå¹¶ä¸”æ˜¯å›ºå®šçš„ã€‚é€šè¿‡æ£€æŸ¥è¿™äº›ç‰¹å®šå­—èŠ‚ï¼Œè½¯ä»¶å¯ä»¥è¿…é€Ÿç¡®å®šæ–‡ä»¶çš„ç±»å‹ï¼Œä»è€Œå†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚è¿™ç§æ–¹æ³•å¯¹äºæ–‡ä»¶æ ¼å¼è¯†åˆ«å’Œå®‰å…¨æ€§æ£€æŸ¥éå¸¸æœ‰ç”¨ã€‚

### Version Number

```bash
00000000 00 61 73 6d 01 00 00 00  01 8a 80 80 80 00 02 60  |.asm...........`|
                      ^  ^  ^  ^
```

æ¥ä¸‹æ¥çš„ 4 ä¸ªå­—èŠ‚ï¼ˆå³`01 00 00 00`ï¼‰æ˜¯ç‰ˆæœ¬å·ï¼Œè¡¨æ˜è¯¥æ–‡ä»¶æŒ‰ç…§ WASM 1.0 è§„èŒƒç¼–ç ã€‚ç‰ˆæœ¬å·ç”¨äºç¡®å®š WASM äºŒè¿›åˆ¶æ–‡ä»¶æ‰€éµå¾ªçš„è§„èŒƒç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿æ­£ç¡®çš„è§£é‡Šå’Œæ‰§è¡Œã€‚è¿™ä¸ªæ–‡ä»¶çš„ç‰ˆæœ¬å·æŒ‡ç¤ºæ–‡ä»¶ç¬¦åˆ WASM 1.0 è§„èŒƒï¼ˆ2.0 å·²ç» work in progress äº†ï¼Œä½†è¿˜æ²¡ç ”ç©¶è¿‡ 2.0 çš„è§„èŒƒï¼‰ã€‚

## Sections

ç„¶åæ˜¯å®é™…å†…å®¹éƒ¨åˆ†ã€‚WebAssembly æ¨¡å—å¯ä»¥åˆ†ä¸º 12 ä¸ªéƒ¨åˆ†ï¼šè‡ªå®šä¹‰ï¼ˆCustomï¼‰ã€ç±»å‹ï¼ˆTypesï¼‰ã€å‡½æ•°ï¼ˆFunctionsï¼‰ã€è¡¨ï¼ˆTablesï¼‰ã€å†…å­˜ï¼ˆMemoriesï¼‰ã€å…¨å±€å˜é‡ï¼ˆGlobalsï¼‰ã€å…ƒç´ æ®µï¼ˆElement Segmentsï¼‰ã€æ•°æ®æ®µï¼ˆData Segmentsï¼‰ã€å¯åŠ¨å‡½æ•°ï¼ˆStart Functionï¼‰ã€ä»£ç ï¼ˆCodeï¼‰ã€å¯¼å‡ºï¼ˆExportsï¼‰å’Œå¯¼å…¥ï¼ˆImportsï¼‰ã€‚ä¸€äº›éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œæ ¹æ®æ¨¡å—çš„å…·ä½“éœ€æ±‚æ¥ç¡®å®šæ˜¯å¦åŒ…å«è¿™äº›éƒ¨åˆ†ã€‚

æ¯ä¸ªéƒ¨åˆ†ï¼Œéƒ½éµå¾ªä»¥ä¸‹ç»“æ„ï¼š

- 1 ä¸ªå­—èŠ‚è¡¨ç¤ºéƒ¨åˆ†**ID**ï¼Œæ ‡è¯†è¯¥éƒ¨åˆ†çš„ç±»å‹ã€‚
- 4 ä¸ªå­—èŠ‚è¡¨ç¤ºéƒ¨åˆ†çš„**å­—èŠ‚æ•° N**ï¼ŒæŒ‡ç¤ºè¯¥éƒ¨åˆ†çš„å†…å®¹å æ®äº†å¤šå°‘å­—èŠ‚ã€‚
- éšåçš„ N ä¸ªå­—èŠ‚åŒ…å«äº†éƒ¨åˆ†çš„**å…·ä½“å†…å®¹**ã€‚

### [Type](https://webassembly.github.io/spec/core/binary/modules.html#type-section)

"Type section"ï¼ˆç±»å‹éƒ¨åˆ†ï¼‰åŒ…å«äº†æ¨¡å—ä¸­æ‰€æœ‰å‡½æ•°çš„ç±»å‹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å‡½æ•°ç­¾å(signature)ã€‚å®ƒåˆ—ä¸¾äº†æ¨¡å—ä¸­æ‰€æœ‰å‡½æ•°çš„"(å‚æ•°ç±»å‹, è¿”å›ç±»å‹)"å¯¹ã€‚å½“ä¸€ä¸ªå‡½æ•°éœ€è¦å£°æ˜å…¶ç±»å‹æ—¶ï¼Œå®ƒåªéœ€æŒ‡å®šä¸€ä¸ªç´¢å¼•ï¼Œå¯¹åº”äº"Type section"ä¸­çš„ç‰¹å®šå‡½æ•°ç­¾åã€‚

è¿™ç§æ–¹å¼æœ‰åŠ©äºå‡å° WebAssembly æ¨¡å—çš„å¤§å°ï¼Œå› ä¸ºå‡½æ•°å¯ä»¥é‡å¤ä½¿ç”¨ç°æœ‰çš„å‡½æ•°ç­¾åï¼Œè€Œæ— éœ€åœ¨æ¯æ¬¡å£°æ˜å‡½æ•°æ—¶éƒ½é‡å¤åˆ—å‡ºå®Œæ•´çš„å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹ã€‚

```bash
00000000 00 61 73 6d 01 00 00 00  01 8a 80 80 80 00 02 60  |.asm...........`|
                                   ^
```

`01` æ˜¯ IDï¼Œå®ƒè¡¨ç¤ºäº†"Type section"ï¼ˆç±»å‹éƒ¨åˆ†ï¼‰çš„å¼€å§‹ã€‚

```bash
00000000 00 61 73 6d 01 00 00 00  01 8a 80 80 80 00 02 60  |.asm...........`|
                                      ^  ^  ^  ^
```

`8a 80 80 80 00` æ˜¯æ•°å­— 10 çš„ LEB-128 è¡¨ç¤ºæ³•ï¼Œç”¨äºè¡¨ç¤ºå†…å®¹éƒ¨åˆ†æ€»å…±å  10 ä¸ªå­—èŠ‚ã€‚[LEB-128](https://en.wikipedia.org/wiki/LEB128)ï¼ˆLittle-Endian Base 128ï¼‰ä½¿ç”¨å¯å˜é•¿åº¦çš„å­—èŠ‚åºåˆ—æ¥è¡¨ç¤ºæ•´æ•°ï¼Œä»¥å‡å°æ•´æ•°è¡¨ç¤ºçš„ç©ºé—´ã€‚

> [!info] ä¸ºå•¥è¦ç”¨è¿™ä¸ªéå¸¸è¿·æƒ‘çš„ LEB-128 è¡¨ç¤ºæ³•?
> æˆ‘ä»¬å¯ä»¥ç”¨å›ºå®šæ•°é‡çš„å­—èŠ‚è¡¨ç¤ºï¼Œä¾‹å¦‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ•´æ•°ç”¨ 4 ä¸ªå­—èŠ‚è¡¨ç¤ºã€‚
> ç„¶è€Œï¼Œå¦‚æœè¦è¡¨ç¤ºæ•°å­— 6ï¼Œå…¶äºŒè¿›åˆ¶è¡¨ç¤ºä¸º`06 00 00 00`ï¼Œè¿™æ„å‘³ç€åä¸‰ä¸ªå­—èŠ‚è¢«æµªè´¹äº†ã€‚å¦‚æœè¦è¡¨ç¤ºå¤§äº`ff ff ff 7f`çš„æ•°å­—ï¼Œä¾‹å¦‚`2147483648`ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ4 ä¸ªå­—èŠ‚å·²ç»ä¸å¤Ÿäº†ã€‚
> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å˜é•¿è¡¨ç¤ºæ³•ï¼šæ›´å¥½çš„**ä¿¡æ¯å¯†åº¦**å’Œæ›´å¹¿æ³›çš„**è¡¨ç¤ºèŒƒå›´**ã€‚

```bash
00000000 00 61 73 6d 01 00 00 00  01 8a 80 80 80 00 02 60  |.asm...........`|
                                                     ^  ^
00000010 01 7f 01 7f 60 00 01 7f  03 83 80 80 80 00 02 00  |....`...........|
          ^  ^
```

æ¥ä¸‹æ¥ 10 ä¸ªå­—èŠ‚è¡¨ç¤ºäº†"Type section"ä¸­çš„å®é™…ç±»å‹ä¿¡æ¯ã€‚å…¶ä¸­ï¼Œ`02`è¡¨ç¤ºç±»å‹éƒ¨åˆ†åŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼ˆå³æ€»å…±æœ‰ä¸¤ç§å‡½æ•°ç±»å‹ï¼‰ã€‚`60` è¡¨ç¤ºè¿™ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ª"function type ([â¡ï¸](https://webassembly.github.io/spec/core/binary/types.html#function-types))"ã€‚æ¥ä¸‹æ¥çš„ `01` è¡¨ç¤ºå‚æ•°æ•°é‡ä¸º 1ï¼Œå› æ­¤æˆ‘ä»¬è¯»å–å¦ä¸€ä¸ªå­—èŠ‚ `7f` ä»¥è·å–è¿™ä¸ªå•ä¸€å‚æ•°çš„ç±»å‹ï¼Œå…¶ä¸­ `7f` ä»£è¡¨ `i32` ([â¡ï¸](https://webassembly.github.io/spec/core/binary/types.html#binary-numtype))ã€‚

è¯»å®Œäº†æ‰€æœ‰è¾“å…¥å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­è¯»å–è¿”å›å€¼çš„æ•°é‡ï¼š`01`ï¼Œå¹¶ä¸”å…¶ç±»å‹ä¹Ÿæ˜¯ `7f`ã€‚å› æ­¤ï¼Œè¿™ä¸ªå…ƒç´ ä¸Šå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ç±»å‹ `i32 => i32`ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„ `fib` å‡½æ•°çš„ç±»å‹ ğŸ˜€ï¼

è¿™ç§æ–¹å¼ä½¿å¾— WebAssembly èƒ½å¤Ÿæœ‰æ•ˆåœ°å®šä¹‰å‡½æ•°çš„å‚æ•°å’Œè¿”å›ç±»å‹ï¼Œæœ‰åŠ©äºæ­£ç¡®è§£é‡Šå’Œæ‰§è¡Œ WebAssembly æ¨¡å—ä¸­çš„å‡½æ•°ã€‚

åŒç†ï¼Œä¸‹ä¸€ä¸ªå‡½æ•°ç±»å‹æ˜¯`void => i32`ã€‚è¾“å…¥å‚æ•°çš„é•¿åº¦ä¸º`0`ï¼Œè€Œåªæœ‰æœ‰ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œç±»å‹ä¸º `i32`ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„`main`å‡½æ•°çš„ç±»å‹ã€‚

<img src="/images/2023-11-02-WASM-parser-cn/type.png" style="margin-top: 2rem; margin-bottom: 2rem; margin-left: auto;
    margin-right: auto; "></img>

### [Import](https://webassembly.github.io/spec/core/binary/modules.html#binary-importsec)

"Import section"ï¼ˆå¯¼å…¥éƒ¨åˆ†ï¼‰å­˜å‚¨äº†å¯¼å…¥ä¿¡æ¯ï¼ŒIDä¸º2ã€‚å¯¼å…¥ä¿¡æ¯åŒ…æ‹¬å¯¼å…¥çš„**æ¨¡å—åç§°(module name)**ã€**å¯¼å…¥çš„åç§°(name)**ä»¥åŠ**å¯¼å…¥æè¿°(description)**ã€‚WebAssemblyæ”¯æŒå››ç§ç±»å‹çš„å¯¼å…¥ï¼šå‡½æ•°ã€è¡¨ã€å†…å­˜å’Œå…¨å±€å˜é‡ã€‚è¿™ä¸ªä¾‹å­ä¸­æ²¡æœ‰Import sectionï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„Export sectionæ¥çœ‹ã€‚


### [Function](https://webassembly.github.io/spec/core/binary/modules.html#function-section)

"Function section"ï¼ˆå‡½æ•°éƒ¨åˆ†ï¼‰åŒ…å«äº†æ‰€æœ‰å‡½æ•°çš„å£°æ˜ï¼ŒIDä¸º3ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¡ç›®æ˜¯æŒ‡å‘"Type section"æ•°ç»„çš„ç´¢å¼•ã€‚

"Type section"å­˜å‚¨å‡½æ•°çš„ç­¾åï¼Œ"Code section"å­˜å‚¨å‡½æ•°çš„å®é™…å®ç°ï¼Œè€Œ"Function section"å°†å®ƒä»¬ä¸¤è€…å…³è”åœ¨ä¸€èµ·ã€‚

```bash
00000010  01 7f 01 7f 60 00 01 7f  03 83 80 80 80 00 02 00  |....`...........|
                                    ^  ^  ^  ^  ^  ^  ^  ^
00000020  01 04 84 80 80 80 00 01  70 00 00 05 83 80 80 80  |........p.......|
           ^
```

`03` è¡¨ç¤ºäº†"Functions section"ï¼ˆå‡½æ•°éƒ¨åˆ†ï¼‰çš„IDã€‚æ¥ä¸‹æ¥çš„ `83 80 80 80 00` è¡¨ç¤ºæ•°å­— 3ï¼ŒæŒ‡ç¤ºäº†æ¥ä¸‹æ¥çš„å†…å®¹é•¿åº¦ä¸º3ã€‚ç´§æ¥ç€çš„ `02`è¡¨ç¤ºæœ‰ä¸¤ä¸ªå‡½æ•°ï¼ˆ`fib` å’Œ `main`ï¼‰ã€‚`00` å’Œ `01` åˆ†åˆ«æ˜¯ç±»å‹éƒ¨åˆ†çš„ç´¢å¼•ï¼Œæ„å‘³ç€ç¬¬ä¸€ä¸ªå‡½æ•°å…·æœ‰ç±»å‹ `i32 => i32`ï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°å…·æœ‰ç±»å‹ `void => i32`ã€‚

<img src="/images/2023-11-02-WASM-parser-cn/function.png" style="margin-top: 2rem; margin-bottom: 2rem; margin-left: auto;
    margin-right: auto; "></img>

### Table

"Table section"ï¼ˆè¡¨éƒ¨åˆ†ï¼‰ä¸€ç³»åˆ—çš„è¡¨ã€‚è¡¨æ˜¯æŸä¸ªç‰¹å®šå¼•ç”¨ç±»å‹çš„æ•°ç»„ï¼ˆå¯ä»¥æ˜¯å‡½æ•°å¼•ç”¨æˆ–å¤–éƒ¨å¼•ç”¨ï¼Œå³è¿è¡Œæ—¶æä¾›çš„å¼•ç”¨ï¼‰ã€‚è¡¨å¯ä»¥åœ¨è¿è¡Œæ—¶æ‰©å±•å¤§å°ï¼Œå› æ­¤å¯ä»¥æŒ‡å®šå¤§å°çš„é™åˆ¶ã€‚æœ€å°å€¼æ˜¯å¿…é€‰çš„ï¼Œè€Œæœ€å¤§å€¼æ˜¯å¯é€‰çš„ã€‚

```bash
00000020  01 04 84 80 80 80 00 01  70 00 00 05 83 80 80 80  |........p.......|
              ^  ^  ^  ^  ^  ^  ^   ^  ^  ^
```

`04` è¡¨ç¤º"Table section"ï¼ˆè¡¨éƒ¨åˆ†ï¼‰çš„éƒ¨åˆ†IDï¼Œå¹¶ä¸”è¿™ä¸ªéƒ¨åˆ†å ç”¨äº†4ä¸ªå­—èŠ‚ã€‚`01` è¡¨ç¤ºåªæœ‰ä¸€ä¸ªè¡¨æ¡ç›®ã€‚`70` è¡¨ç¤ºè¿™ä¸ªè¡¨çš„ç±»å‹æ˜¯ä¹Ÿå°±æ˜¯å‡½æ•°å¼•ç”¨([â¡ï¸](https://webassembly.github.io/spec/core/binary/types.html#reference-types))ã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ª `00` åˆ†åˆ«è¡¨ç¤ºå¤§å°é™åˆ¶æ ‡å¿—ï¼ˆlimit flagï¼‰å’Œåˆå§‹å¤§å°ï¼ˆlimit initialï¼‰[â¡ï¸](https://webassembly.github.io/spec/core/binary/types.html#limits)ã€‚å¤§å°é™åˆ¶æ ‡å¿—æŒ‡ç¤ºè¡¨æ˜¯å¦å…·æœ‰æœ€å¤§å¤§å°é™åˆ¶ï¼Œè€Œåˆå§‹å¤§å°è¡¨ç¤ºè¡¨çš„æœ€å°å¤§å°ã€‚

ç»¼ä¸Šï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè¡¨ï¼Œç”¨äºå­˜å‚¨å‡½æ•°å¼•ç”¨ï¼Œæœ€å°å¤§å°ä¸º0ï¼Œæ²¡æœ‰æœ€å¤§å¤§å°é™åˆ¶ã€‚


<img src="/images/2023-11-02-WASM-parser-cn/table.png" style="margin-top: 2rem; margin-bottom: 2rem; margin-left: auto;
    margin-right: auto; "></img>

### Memory

"Memory section"ï¼ˆå†…å­˜éƒ¨åˆ†ï¼‰å®šä¹‰äº†çº¿æ€§å†…å­˜ï¼ŒåŒ…å«äº†åŸå§‹æœªè§£é‡Šå­—èŠ‚ã€‚çº¿æ€§å†…å­˜å¯ä»¥é€šè¿‡"Data section"ï¼ˆæ•°æ®éƒ¨åˆ†ï¼‰è¿›è¡Œåˆå§‹åŒ–ï¼Œå®ƒè¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶æ‰©å±•ï¼Œå¹¶å…·æœ‰å¤§å°é™åˆ¶ã€‚


```bash
00000020  01 04 84 80 80 80 00 01  70 00 00 05 83 80 80 80  |........p.......|
                                             ^  ^  ^  ^  ^
00000030  00 01 00 01 06 81 80 80  80 00 00 07 97 80 80 80  |................|
           ^  ^  ^  ^
```

`05` è¡¨ç¤º"Memory section"ï¼ˆå†…å­˜éƒ¨åˆ†ï¼‰çš„éƒ¨åˆ†IDï¼Œè¿™ä¸ªéƒ¨åˆ†å ç”¨äº†3ä¸ªå­—èŠ‚ã€‚ä¸ä¹‹å‰çš„"Table section"ç›¸ä¼¼ï¼Œè¿™é‡Œä¹Ÿåªæœ‰ä¸€ä¸ªå†…å­˜å‘é‡ï¼Œæ²¡æœ‰æœ€å¤§å¤§å°é™åˆ¶ï¼Œå¹¶ä¸”å…·æœ‰æœ€å°å¤§å°ä¸º1ã€‚

<img src="/images/2023-11-02-WASM-parser-cn/memory.png" style="margin-top: 2rem; margin-bottom: 2rem; margin-left: auto;
    margin-right: auto; "></img>

### [Global](https://webassembly.github.io/spec/core/binary/modules.html#global-section)

"Global variable section"ï¼ˆå…¨å±€å˜é‡éƒ¨åˆ†ï¼‰å®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡çš„æ•°ç»„ã€‚æ¯ä¸ªå…¨å±€å˜é‡å­˜å‚¨ç»™å®šå…¨å±€ç±»å‹çš„å•ä¸ªå€¼ï¼Œå¹¶æŒ‡å®šå…¨å±€å˜é‡æ˜¯åªè¯»è¿˜æ˜¯å¯å†™çš„ã€‚æ¯ä¸ªå…¨å±€å˜é‡éƒ½ä½¿ç”¨å¸¸é‡åˆå§‹åŒ–è¡¨è¾¾å¼ï¼ˆconstant initializer expressionï¼‰æ¥è¿›è¡Œåˆå§‹åŒ–ã€‚

```bash
00000030  00 01 00 01 06 81 80 80  80 00 00 07 97 80 80 80  |................|
                       ^  ^  ^  ^   ^  ^  ^
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥çœ‹åˆ°IDæ˜¯`06`ï¼Œæ€»é•¿åº¦ä¸º1ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªå­—èŠ‚ã€‚`00`è¡¨ç¤ºè¿™ä¸ªæ•°ç»„çš„é•¿åº¦æ˜¯0ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰å…¨å±€å˜é‡ã€‚


<img src="/images/2023-11-02-WASM-parser-cn/global.png" style="margin-top: 2rem; margin-bottom: 2rem; margin-left: auto;
    margin-right: auto; "></img>

### [Export](https://webassembly.github.io/spec/core/binary/modules.html#export-section)

"Export section"ï¼ˆå¯¼å‡ºéƒ¨åˆ†ï¼‰å®šä¹‰äº†ä¸€ç»„å¯¼å‡ºé¡¹ï¼Œè¿™äº›å¯¼å‡ºé¡¹åœ¨æ¨¡å—å®ä¾‹åŒ–åæˆä¸ºå¯¹å®¿ä¸»ç¯å¢ƒå¯è®¿é—®çš„æ¥å£ã€‚æ¯ä¸ªå¯¼å‡ºé¡¹ç”±ä¸€ä¸ª**åç§°ï¼ˆnameï¼‰** å’Œä¸€ä¸ª **å¯¼å‡ºæè¿°ï¼ˆdescriptionï¼‰** ç»„æˆï¼Œå¯¼å‡ºæè¿°å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡å‘å‡½æ•°ã€è¡¨ã€å†…å­˜æˆ–å…¨å±€å˜é‡çš„ç´¢å¼•ï¼ˆåªè¦æä¾›ç´¢å¼•å°±è¡Œå•¦ï¼Œå› ä¸ºæ•°æ®éƒ½åœ¨æœ¬æ¨¡å—å†…ï¼‰ã€‚

å¯¼å‡ºä½¿å¾—WebAssemblyæ¨¡å—å¯ä»¥å‘å®¿ä¸»ç¯å¢ƒå…¬å¼€ç‰¹å®šçš„æ¥å£ï¼Œä»¥ä¾¿å®¿ä¸»ç¯å¢ƒå¯ä»¥ä¸æ¨¡å—è¿›è¡Œäº¤äº’ã€‚è¿™äº›å¯¼å‡ºé¡¹å¯ä»¥åŒ…æ‹¬å‡½æ•°ã€è¡¨ã€å†…å­˜æˆ–å…¨å±€å˜é‡çš„å¼•ç”¨ï¼Œä½¿å®¿ä¸»ç¯å¢ƒèƒ½å¤Ÿè°ƒç”¨æ¨¡å—ä¸­çš„å‡½æ•°ã€è®¿é—®æ¨¡å—ä¸­çš„æ•°æ®ç»“æ„ç­‰ã€‚

```bash
00000030  00 01 00 01 06 81 80 80  80 00 00 07 97 80 80 80  |................|
                                             ^  ^  ^  ^  ^
00000040  00 03 06 6d 65 6d 6f 72  79 02 00 03 66 69 62 00  |...memory...fib.|
           ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^
00000050  00 04 6d 61 69 6e 00 01  0a d7 80 80 80 00 02 c6  |..main..........|
           ^  ^  ^  ^  ^  ^  ^  ^
```

07 è¡¨ç¤º"Export section"ï¼ˆå¯¼å‡ºéƒ¨åˆ†ï¼‰çš„IDï¼Œ`97 80 80 80 00`è¡¨ç¤ºè¿™ä¸ªéƒ¨åˆ†å ç”¨äº†23ä¸ªå­—èŠ‚ã€‚`03` è¡¨ç¤ºæœ‰3ä¸ªå…¨å±€å˜é‡ï¼Œè€Œåé¢çš„ `06` è¡¨ç¤ºå­—ç¬¦ä¸² 'memory' ï¼ˆä¹Ÿå°±æ˜¯è¯¥å¯¼å‡ºé¡¹çš„åç§°ï¼‰çš„å­—ç¬¦æ•°ï¼Œå¹¶æ¥ä¸‹æ¥çš„6ä¸ªæ•°å­—è¡¨ç¤ºäº† 'memory' å­—ç¬¦çš„ASCIIç¼–ç ã€‚`02` è¡¨ç¤ºå¯¼å‡ºæ¡ç›®æ˜¯ä¸€ä¸ªå†…å­˜ç´¢å¼•(memory index[â¡ï¸](https://webassembly.github.io/spec/core/binary/modules.html#binary-memidx))ï¼Œè€Œåé¢çš„ `00` æ˜¯å®é™…çš„ç´¢å¼•å€¼ã€‚

ç»¼ä¸Šï¼Œæˆ‘ä»¬æ­£åœ¨å¯¼å‡º"Memory section"ä¸­çš„ç¬¬ä¸€ä¸ªå†…å­˜å‘é‡ï¼Œå¹¶å°†å…¶å‘½åä¸º memoryã€‚å®¿ä¸»ç¯å¢ƒå¯ä»¥ä¸æ¨¡å—ä¸­çš„å†…å­˜è¿›è¡Œäº¤äº’ï¼Œé€šè¿‡åç§° memory å¼•ç”¨å†…å­˜ã€‚

Following the same rule to process the rest, we will get a function exported named `fib`, which points to the index 0 of the Function section, and the same with `main`.


æ ¹æ®ç›¸åŒçš„è§„åˆ™å¤„ç†å…¶ä»–å¯¼å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªåä¸º`fib`çš„å¯¼å‡ºå‡½æ•°ï¼Œå®ƒæŒ‡å‘"Function section"çš„ç´¢å¼•0ï¼Œè€Œ`main`ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼ŒæŒ‡å‘"Function section"çš„ç´¢å¼•1ã€‚

<img src="/images/2023-11-02-WASM-parser-cn/export.png" style="margin-top: 2rem; margin-bottom: 2rem; margin-left: auto;
    margin-right: auto; "></img>

### [Start](https://webassembly.github.io/spec/core/binary/modules.html#start-section)

"Start section"ï¼ˆèµ·å§‹å‡½æ•°éƒ¨åˆ†ï¼‰ï¼ŒåŒ…å«ä¸€ä¸ªèµ·å§‹å‡½æ•°ç´¢å¼•ã€‚ç±»ä¼¼äºCä¸­çš„`main`å‡½æ•°ã€‚åœ¨WebAssemblyå®ä¾‹åŒ–äº†æ¨¡å—ä¹‹åï¼Œå®ƒå°±ä¼šæ‰§è¡Œè¿™ä¸ªèµ·å§‹å‡½æ•°ã€‚"Start section"çš„IDæ˜¯8ã€‚å†…å®¹å°±æ˜¯ä¸€ä¸ª`u32`è¡¨ç¤ºçš„function indexã€‚


### [Element](https://webassembly.github.io/spec/core/binary/modules.html#element-section)


è¡¨çš„åˆå§‹å†…å®¹æ˜¯æœªåˆå§‹åŒ–çš„ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å…ƒç´ æ®µï¼ˆElement segmentsï¼‰æ¥ä»é™æ€å…ƒç´ æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ã€‚å…ƒç´ æ®µæ˜¯WebAssemblyä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒå…è®¸åˆå§‹åŒ–è¡¨çš„å­èŒƒå›´ï¼Œå°†é™æ€å…ƒç´ å­˜å‚¨åœ¨è¡¨ä¸­ã€‚

ä¸€æ—¦å…ƒç´ è¢«åŠ è½½åˆ°è¡¨ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨"CALL_INDIRECT"æ“ä½œæ¥é—´æ¥è°ƒç”¨è¡¨ä¸­çš„å‡½æ•°ã€‚


$$ \begin{align*}elem &:= \{\text{type}\ reftype,\ \\ &\text{init}\ vec(expr),\ \text{mode}\ mode\}\end{align*}$$

$$\begin{align*} elemmode &::= \text{passive} \\ &|\text{active}\{\text{table}~\text{tableidx},~\text{offset}~\text{expr}\} \\ &|\text{declarative}\end{align*}$$

### Code

Code section consists of a vector of code entries that are pairs of value type vectors and expressions. They represent the locals and body field of the functions in the component of a module.

```bash
00000050  00 04 6d 61 69 6e 00 01  0a d7 80 80 80 00 02 c6  |..main..........|
                                    ^  ^  ^  ^  ^  ^  ^  ^
00000060  80 80 80 00 01 02 7f 41  01 21 02 02 40 20 00 41  |.......A.!..@ .A|
           ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^
00000070  01 72 41 01 46 0d 00 20  00 41 7e 6a 21 00 41 01  |.rA.F.. .A~j!.A.|
           ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^
00000080  21 02 03 40 20 00 41 01  6a 10 00 20 02 6a 21 02  |!..@ .A.j.. .j!.|
           ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^
00000090  20 00 41 01 72 21 01 20  00 41 7e 6a 21 00 20 01  | .A.r!. .A~j!. .|
           ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^
000000a0  41 01 47 0d 00 0b 0b 20  02 0b 86 80 80 80 00 00  |A.G.... ........|
           ^  ^  ^  ^  ^  ^  ^  ^   ^  ^  ^  ^  ^  ^  ^  ^
000000b0  41 05 10 00 0b                                    |A....|
           ^  ^  ^  ^  ^
```

This whole bunch of bytes are all dedicated to the Code section, which has an id of 10. `02` means there will be two function definitions. `c6 80 80 80 00` indicates the body size (70) of the first function definition. Then the local variables, grouped in (number, type), are specified. `01` means there will be only 1 type of variable, and `02 7f` represents two `i32` variables (which is all local variable we need since there is only 1 type of local variable). The rest of the bytes (body size - bytes taken by local variables) are instructions.

From the above example we see there is only two `i32` variables for the first function and no variable for the second function.

## Epilogue

So we have successfully parsed a wasm binary. Next blog we will introduce how the pieces come together in runtime.

## Appendix

### `Fib` in C++

The source code of fib in c++ that I used to compile to wasm.

```cpp
int fib(int n){
  if(n == 0 || n == 1) return 1;
  return fib(n-1) + fib(n-2);
}
int main(){
  return fib(5);
}
```
